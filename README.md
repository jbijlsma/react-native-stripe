# Example of using the Stripe Payments API in a React Native Expo app

<p float="left" align="middle">
<img src="./screenshots/native_paymentsheet_dark.gif" width="24%">
<img src="./screenshots/native_paymentsheet_light.gif" width="24%">
<img src="./screenshots/webview_dark.gif" width="24%">
<img src="./screenshots/webview_light.gif" width="24%">
</p>

<p float="left" align="middle">
<img src="./screenshots/native_custom_dark.gif" width="48%">
<img src="./screenshots/native_custom_light.gif" width="48%">
</p>

# Running locally

Stripe requires that you create your own backend server (API) to create Payment Intentions. In this example the custom backend server (API) is implemented in NodeJs.

To run this demo, you must first sign up with Stripe and get your Publishable key and Secret key.

## Run the server

Copy the .env.example file:

```bash
cp ./server/.env.example ./server/.env
```

Update the .env file:

```
STRIPE_SECRET_KEY={your Secret key}
```

Start the server:

```bash
npm run dev
```

## Run the client

Copy the .env_local.example file:

```bash
cp ./client/.env_local.example ./client/.env_local
```

Update the .env_local file:

```
STRIPE_PUBLIC_KEY={your Publishable key}
```

Start the client:

```bash
npm start
```

## Good to know

- If you want to run on your real (iOS) device and want to access the Payment API running on your own machine you can update your shell startup config file (~/.zshrc in my case) and export your machine's network interface ip with:

```bash
export LOCAL_IP=$(ipconfig getifaddr en0)
```

The babel.config.js file already has LOCAL_IP in the allowed list so it is available in the app:

```
allowlist: [ .., "LOCAL_IP"],
```

- Code that looks ok and compiles can easily crash the Expo Go app without any error messages appearing in the console. For example calling Alert.alert(..) with only one argument or calling Alert.alert(.., ..) with 2 arguments, but not passing a string to the arguments.

## Testing the server

To create a payment intent:

```bash
curl -X POST -H "Content-Type: application/json" \
-d "{\"amount\":18950}" http://localhost:3000/payments/intent
```

Stripe uses webhooks to inform you about events such as when a PaymentIntent succeeded / failed. You can either use the Stripe CLI to test your webhooks locally or use a tool like ngrok to expose your /webhook endpoint on the internet.

To test using the Stripe CLI:

```bash
stripe listen --forward-to localhost:4242/stripe-events/webhook
```

Then in another terminal:

```bash
stripe trigger payment_intent.succeeded
```

More info here: https://dashboard.stripe.com/test/webhooks/create?endpoint_location=local

When using ngrok you can use the Stripe Dashboard to configure the publicly exposed /webhook provided by ngrok. See: https://ngrok.com/docs/getting-started/.

IMPORTANT: don't forget to update the .env file and set the correct STRIPE_WEBHOOK_SECRET! When using ngrok you use the signing secret from the Stripe dashboard and when using the Stripe CLI you use the fixed test signing secret.

## Thunder Client API examples

The Thunder Client can be installed as a VS code extension and is an alternative to using tools like PostMan or curl directly within VS code. You can import the Thunder Client collection in /docs/thunder-collection-stripe.json. In the collection settings under Auth -> Basic set the username to your Stripe secret key (sk_xxx).

## Stripe (Web) Payment Flow

When using the (web) based payment flow the following events are generated by Stripe:

- calling stripe.paymentIntents.create({ ... }) generates one event: payment_link.created
- when the user clicks on a payment method 2 events are generated: payment_intent.created and payment_intent.requires_action (for PayNow at least). Interesting enough the payment_intent.requires_action for PayNow also contains the PayNow QR Code:

```json
"next_action": {
  "paynow_display_qr_code": {
    "data": "https://stripe.com/payment_methods/test_payment?payment_attempt=xxx",
    "hosted_instructions_url": "https://qr.stripe.com/xxx",
    "image_url_png": "https://qr.stripe.com/xxx.png",
    "image_url_svg": "https://qr.stripe.com/xxx.svg"
  },
  "type": "paynow_display_qr_code"
}
```

- when the user pays successfully 3 events are created: payment_intent.succeeded, charge.succeeded and checkout.session.async_payment_succeeded. Note: in the Stripe test environment there was a 20-minute delay before these events were visible in the UI.

- when payment fails 2 events are created: payment_intent.payment_failed and charge.failed. In this case the events were visible in the UI within 10 seconds.

- for testing the Stripe CLI is a very useful tool

## GrabPay flow

Refer to the "Create and confirm PaymentIntent (GrabPay)" Thunder Client request. If you execute it you will see in the response a next_action:

```json
"next_action": {
  "redirect_to_url": {
    "return_url": "http://localhost:3000",
    "url": "https://pm-redirects.stripe.com/authorize/acct_1NIOT8E0jVisloCu/pa_nonce_xxx"
  },
  "type": "redirect_to_url"
},
```

Doing a get on the url returns a redirect response (302) with the location header:

```bash
curl -s -o /dev/null -D - https://pm-redirects.stripe.com/authorize/acct_1NIOT8E0jVisloCu/pa_nonce_O5hkm97ZZkDoCRWqSySVo1Dpl3QfKMw
```

```bash
location: https://stripe.com/payment_methods/test_payment?payment_attempt=payatt_xxx&pa_nonce_xxx
```

Finally you can now set the PaymentIntent to succeeded with using the nonce:

```bash
curl "https://pm-redirects.stripe.com/return/acct_1NIOT8E0jVisloCu/pa_nonce_O5hozBomLNGAYncOqOWWWOPPiBtDR0o?code=foo&state=bar"
```

Approve it:

```bash
curl "https://pm-redirects.stripe.com/return/acct_1NIOT8E0jVisloCu/pa_nonce_O5hozBomLNGAYncOqOWWWOPPiBtDR0o?code=foo&state=bar"
```

Alternatively set it to failed with:

```bash
curl "https://pm-redirects.stripe.com/return/acct_1NIOT8E0jVisloCu/pa_nonce_O5hozBomLNGAYncOqOWWWOPPiBtDR0o?error=baz"
```

### Local testing with curl

Create the PaymentIntent:

```bash
curl -X POST http://localhost:4242/stripe-grab/payment-intents \
   -H 'Content-Type: application/json' \
   -d '{"amount": "900"}'
```

Approve it:

```bash
curl "http://localhost:4242/stripe-grab/payment-intents/pa_nonce_O5imDDkkF61DjRLzex7uuepMyXq4UfZ/approve"
```

Decline it:

```bash
curl "http://localhost:4242/stripe-grab/payment-intents/pa_nonce_O5imDDkkF61DjRLzex7uuepMyXq4UfZ/decline"
```

## Thoughts on the optimal Stripe payment flow in React Native mobile apps for PayNow

If we only want to offer PayNow as the payment option:

1. Have a "Top-up Credit" button in the UI
2. When the user clicks the button show a screen where the amount can be specified. Provide some standard amounts and some options to get discount if they buy more credit?
3. After choosing the amount, use stripe.paymentIntents.create({ ... }) in a NodeJs AWS Lambda function to create the PaymentIntent. When succesful, also create a firebase realtime db object under /users/{uuid}/top-ups that has a unique id, amount, and timestamp and the id of the Stripe PaymentIntent. It would be best if the PaymentIntent object returned by stripe.paymentIntents.create({ ... }) would include the PayNow QR code, but it does not at the moment. So we have to rely on a webhook to listen for the
4. In a NodeJs AWS Lambda function listen for the payment_intent.requires_action event. This also means configuring a webhook in the Stripe dashboard. In the webhook we get the PayNow QR code image from the event (from next_action.paynow_display_qr_code.image_url_png) and store it in the top-ups object in firebase
5. Subscribe to real-time firebase updates on the top-ups object. That means that as soon as the PayNowQRCodePng is stored in the realtime db our app will be notified and we can show the QR code image.
6. In the same NodeJs AWS Lambda function listen for the payment_intent.succeeded event. Update the status of the top-up in firebase to 'succeeded' with a timestamp. The app should subscribe to this change and display a message to the user. The top-up history should show the top-up status as 'succesful' and the new credit amount should appear.

Offering additional payment methods would be very similar. We basically just need to create a PaymentSheet similar to the one that Stripe offers. To support card payments we can use the CardField React Native component:

```javascript
import { CardField, useStripe } from "@stripe/stripe-react-native";
```

As an alternative for the firebase realtime updates we could configure the React Native app to listen to an alternative event bus. All cloud providers will have things on offer.

## React Native PaymentSheet issues

1. Supported Payment Types not showing up: although Payment Types such as GrapPay and PayNow show up when using the PaymentSheet in a regular React web app, they don't show up when using the React Native PaymentSheet.

2. Frequent Crashes: the Expo Go app frequently crashes when something is configured wrongly. I hope the app does not crash when running outside the Expo Go app.

3. Lack of documentation: when it comes to any payment methods besides (credit) cards there is not much documentation available.

## Stripe Docs

In the Stripe Dashboard under Developers -> Events you can see all events that were generated.
This include events for offline payments such as PayNow. When you click on an event you can see the details, including which webhooks were called and whether the calls were successful or not.

https://dashboard.stripe.com/test/events

Useful docs:

https://stripe.com/docs/webhooks
https://stripe.com/docs/api/events
https://stripe.com/docs/cli
https://stripe.com/docs/payment-links/customer-info

http://localhost:3000/completion?payment_intent=pi_3NJVCYE0jVisloCu0nLHLM7P&payment_intent_client_secret=pi_3NJVCYE0jVisloCu0nLHLM7P_secret_HUhSLTG440m7KtDHJ08VA5FTB&redirect_status=succeeded

https://pm-hooks.stripe.com/paynow/test/payment?external_transaction_id=payatt_3NJVEoE0jVisloCu0EGNR24V&merchant_id=acct_1NIOT8E0jVisloCu&testmode_status=SUCCESS

https://pm-redirects.stripe.com/return/acct_1NIOT8E0jVisloCu/pa_nonce_O5guS9ntf4sgwtByGiYO2xdQmLkSBKM?error=baz

Location Header in response:

https://stripe.com/payment_methods/test_payment?payment_attempt=payatt_3NJVRgE0jVisloCu1FLj7Np4&redirect_uri=https%3A%2F%2Fpm-redirects.stripe.com%2Freturn%2Facct_1NIOT8E0jVisloCu%2Fpa_nonce_O5hFZzdm1x7DakS3gbEGfAPI7DNDPVC

https://pm-redirects.stripe.com/return/acct_1NIOT8E0jVisloCu/pa_nonce_O5hFZzdm1x7DakS3gbEGfAPI7DNDPVC?code=foo&amp;state=bar

https://pm-redirects.stripe.com/return/acct_1NIOT8E0jVisloCu/pa_nonce_O5hFZzdm1x7DakS3gbEGfAPI7DNDPVC?error=baz
